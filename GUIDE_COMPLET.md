# üéì Guide ultime : De GitHub √† GitLab avec Docker Hub

Ce document explique TOUT ce qui a √©t√© fait pour migrer votre projet de GitHub vers GitLab avec push vers Docker Hub.

## üìÅ Fichiers cr√©√©s

### 1. Configuration CI/CD

#### `.gitlab-ci.yml` ‚≠ê **FICHIER PRINCIPAL**
- **Remplace** : `.github/workflows/build.yml`
- **Fonction** : D√©finit le pipeline GitLab CI/CD
- **Contient** :
  - Stage `build` avec 6 jobs parall√®les
  - Authentification Docker Hub
  - Build des images avec Buildah
  - Push automatique sur main/blackaurora
  - Support Cosign pour signature
  - Labels OCI standards

#### `renovate.json`
- **Remplace** : `.github/renovate.json5` et `.github/dependabot.yml`
- **Fonction** : Mises √† jour automatiques des d√©pendances
- **Note** : N√©cessite Renovate Bot activ√© sur GitLab

### 2. Documentation

#### `README.md` (modifi√©)
- Mis √† jour avec informations GitLab CI/CD
- Instructions pour toutes les variantes d'images
- Section d√©di√©e √† la migration

#### `START_HERE.txt` ‚≠ê **COMMENCEZ ICI**
- Guide visuel ASCII ultra-simplifi√©
- 2 options : automatique ou manuelle
- Temps estim√©s et aide rapide

#### `QUICK_START_DOCKERHUB.md` 
- Guide de d√©marrage rapide (5 minutes)
- Parfait pour les impatients
- R√©sum√© des √©tapes essentielles

#### `DOCKER_HUB_SETUP.md` ‚≠ê **GUIDE PRINCIPAL DOCKER HUB**
- Guide complet et d√©taill√©
- Cr√©ation du token Docker Hub (avec captures d'√©cran textuelles)
- Configuration GitLab Variables pas-√†-pas
- D√©pannage approfondi
- Limites du plan gratuit
- Bonnes pratiques de s√©curit√©

#### `GITLAB_CI_SETUP.md`
- Guide complet GitLab CI/CD
- Explications sur le pipeline
- Variables d'environnement
- Configuration des schedules
- Instructions Cosign compl√®tes
- **Alternatives aux registries** (Docker Hub, Quay.io, ghcr.io, ACR, ECR)
- Tableau comparatif des registries

#### `MIGRATION_SUMMARY.md`
- R√©sum√© ex√©cutif de la migration
- Diff√©rences GitHub vs GitLab
- Liste de tous les fichiers cr√©√©s
- Prochaines √©tapes sugg√©r√©es

#### `CHECKLIST.md` ‚≠ê **√Ä UTILISER PENDANT LA CONFIG**
- Checklist compl√®te √©tape par √©tape
- Cases √† cocher pour suivre progression
- Configuration optionnelle (Cosign, Renovate, Schedules)
- Section d√©pannage
- Espace pour notes personnelles

#### `PROJECT_STRUCTURE.md`
- Arborescence compl√®te du projet
- Workflow visuel du pipeline
- Guide "Quel fichier lire ?"
- Documentation des images produites
- Variables d'environnement
- Guide de personnalisation

### 3. Scripts

#### `setup-dockerhub.sh` ‚≠ê **SCRIPT AUTOMATIQUE**
- **Fonction** : Configure automatiquement Docker Hub
- **Actions** :
  1. Demande votre username Docker Hub
  2. Met √† jour `.gitlab-ci.yml` automatiquement
  3. Cr√©e un backup (`.gitlab-ci.yml.backup`)
  4. Affiche les instructions pour GitLab
- **Usage** : `./setup-dockerhub.sh`

## üîë Points cl√©s de la configuration

### Variables √† modifier

#### Dans `.gitlab-ci.yml` (ligne 6)
```yaml
IMAGE_REGISTRY: "docker.io/VOTRE_USERNAME"
                            ^^^^^^^^^^^^
                    IMPORTANT : Remplacer ceci !
```

**Deux m√©thodes** :
- **Automatique** : Ex√©cuter `./setup-dockerhub.sh`
- **Manuelle** : √âditer le fichier manuellement

### Variables √† configurer dans GitLab

Dans **Settings ‚Üí CI/CD ‚Üí Variables**, ajouter :

| Variable | Valeur | Protection | Masqu√© |
|----------|--------|------------|--------|
| `DOCKERHUB_USERNAME` | Votre username Docker Hub | ‚úÖ | ‚úÖ |
| `DOCKERHUB_TOKEN` | Votre token d'acc√®s | ‚úÖ | ‚úÖ |
| `COSIGN_PRIVATE_KEY` | Cl√© Cosign (optionnel) | ‚úÖ | ‚úÖ |

## üöÄ Processus de configuration recommand√©

### Pour les d√©butants (m√©thode guid√©e)

1. **Lire** `START_HERE.txt` (2 min)
2. **Ex√©cuter** `./setup-dockerhub.sh` (1 min)
3. **Cr√©er** token Docker Hub via https://hub.docker.com/settings/security (3 min)
4. **Configurer** variables GitLab via Settings ‚Üí CI/CD ‚Üí Variables (2 min)
5. **Suivre** `CHECKLIST.md` pour v√©rifier chaque √©tape (5 min)
6. **Pousser** vers GitLab : `git push origin main` (1 min)
7. **Surveiller** le pipeline dans CI/CD ‚Üí Pipelines (20-40 min)

**Total : ~35-55 minutes** (dont 20-40 min d'attente du build)

### Pour les exp√©riment√©s (m√©thode rapide)

1. **Lire** `QUICK_START_DOCKERHUB.md` (2 min)
2. **Ex√©cuter** `./setup-dockerhub.sh` (1 min)
3. **Configurer** GitLab Variables (2 min)
4. **Pousser** et go ! (30 sec)

**Total : ~5-6 minutes** (+ temps de build)

### Pour les perfectionnistes (m√©thode compl√®te)

1. **Lire** tous les guides dans cet ordre :
   - `README.md` ‚Üí Vue d'ensemble
   - `MIGRATION_SUMMARY.md` ‚Üí Comprendre la migration
   - `DOCKER_HUB_SETUP.md` ‚Üí D√©tails Docker Hub
   - `GITLAB_CI_SETUP.md` ‚Üí D√©tails GitLab CI/CD
   - `PROJECT_STRUCTURE.md` ‚Üí Architecture du projet

2. **Suivre** `CHECKLIST.md` compl√®tement
3. **Configurer** options avanc√©es (Cosign, Schedules, Renovate)
4. **Tester** et valider

**Total : ~1-2 heures** (configuration compl√®te + options avanc√©es)

## üéØ R√©sultat attendu

### Images Docker Hub cr√©√©es

Apr√®s le premier build r√©ussi, vous aurez **6 repositories** sur Docker Hub :

```
docker.io/VOTRE_USERNAME/
‚îú‚îÄ‚îÄ tuxedo-aurora-dx          (Aurora DX + Tuxedo)
‚îú‚îÄ‚îÄ tuxedo-aurora-black       (Aurora Black + Tuxedo)
‚îú‚îÄ‚îÄ aurora-custom             (Aurora sans drivers)
‚îú‚îÄ‚îÄ tuxedo-bluefin-dx         (Bluefin DX + Tuxedo)
‚îú‚îÄ‚îÄ tuxedo-bluefin-black      (Bluefin Black + Tuxedo)
‚îî‚îÄ‚îÄ bluefin-custom            (Bluefin sans drivers)
```

### Tags cr√©√©s pour chaque image

```
latest              # Derni√®re version
latest.20251001     # Version avec date
20251001            # Tag de date simple
```

### D√©clencheurs du pipeline

Le pipeline se d√©clenche automatiquement sur :
- ‚úÖ Push sur `main`
- ‚úÖ Push sur `blackaurora`
- ‚úÖ Merge Request (build seulement, pas de push)
- ‚úÖ Schedule (si configur√©)
- ‚úÖ Manuel (via interface GitLab)

### Temps de build

| √âtape | Dur√©e estim√©e |
|-------|---------------|
| Checkout | 10-30 secondes |
| Authentification | 5 secondes |
| Build d'une image | 15-25 minutes |
| **Total (6 images en parall√®le)** | **20-40 minutes** |

## üîß Modifications apport√©es au code

### Fichiers GitHub (conservation)

Les fichiers suivants sont **conserv√©s** mais **non utilis√©s** :
- `.github/workflows/build.yml`
- `.github/dependabot.yml`
- `.github/renovate.json5`

Vous pouvez les **supprimer** si vous voulez, ou les **garder** comme r√©f√©rence.

### Changements principaux

| Aspect | GitHub Actions | GitLab CI (maintenant) |
|--------|---------------|------------------------|
| **Fichier config** | `.github/workflows/build.yml` | `.gitlab-ci.yml` |
| **Registry** | `ghcr.io` | `docker.io` |
| **Auth user** | `github.actor` | `DOCKERHUB_USERNAME` |
| **Auth token** | `GITHUB_TOKEN` | `DOCKERHUB_TOKEN` |
| **Matrix builds** | `strategy.matrix` | Jobs parall√®les explicites |
| **Syntax** | GitHub Actions YAML | GitLab CI YAML |
| **Runner** | `ubuntu-24.04` | `quay.io/buildah/stable` |
| **Build tool** | Buildah (via actions) | Buildah (direct) |

## üõ°Ô∏è S√©curit√©

### Bonnes pratiques impl√©ment√©es

‚úÖ **Tokens au lieu de mots de passe**
- Utilise `DOCKERHUB_TOKEN`, pas le mot de passe

‚úÖ **Variables prot√©g√©es et masqu√©es**
- Les secrets ne sont pas visibles dans les logs

‚úÖ **No push sur MR**
- Les Merge Requests ne poussent pas vers Docker Hub

‚úÖ **Signature optionnelle avec Cosign**
- Images sign√©es cryptographiquement si configur√©

### √Ä faire pour renforcer la s√©curit√©

‚òê Activer Cosign (voir `GITLAB_CI_SETUP.md`)
‚òê Utiliser des runners priv√©s pour builds sensibles
‚òê Activer scan de s√©curit√© des images
‚òê Renouveler r√©guli√®rement les tokens

## üìä Diff√©rences de fonctionnement

### GitHub Actions (avant)

```
Trigger ‚Üí Checkout ‚Üí Generate Matrix ‚Üí Build Images ‚Üí Push to ghcr.io ‚Üí Sign
```

### GitLab CI (maintenant)

```
Trigger ‚Üí 6 jobs parall√®les ‚Üí Build + Push to docker.io ‚Üí Sign (optionnel)
```

**Avantages de l'approche GitLab** :
- ‚úÖ Plus simple (pas de g√©n√©ration de matrix)
- ‚úÖ Plus pr√©visible (jobs explicites)
- ‚úÖ Plus facile √† d√©boguer
- ‚úÖ Plus rapide (builds vraiment parall√®les)

**Inconv√©nients** :
- ‚ùå Moins flexible (ajout manuel de nouveaux variants)
- ‚ùå Duplication de code (template r√©utilis√©)

## üîÑ Workflow de d√©veloppement

### Ajouter une nouvelle variante

1. **Cr√©er le Containerfile**
   ```bash
   mkdir -p Containerfiles/nouvelle-variante
   vim Containerfiles/nouvelle-variante/Containerfile
   ```

2. **Ajouter le job dans `.gitlab-ci.yml`**
   ```yaml
   build-nouvelle-variante:
     extends: .build-image-template
     variables:
       CONTAINERFILE: "Containerfiles/nouvelle-variante/Containerfile"
       IMAGE_NAME: "nom-de-limage"
   ```

3. **Commiter et pousser**
   ```bash
   git add .
   git commit -m "Add nouvelle-variante"
   git push origin main
   ```

### Tester localement

```bash
# Build d'une image en local
buildah bud \
  --format=oci \
  --file=Containerfiles/aurora/dx/Containerfile \
  --tag=tuxedo-aurora-dx:test \
  .

# Test de l'image
podman run -it tuxedo-aurora-dx:test bash
```

## üÜò Aide et d√©pannage

### Probl√®mes courants

| Probl√®me | Document √† consulter |
|----------|---------------------|
| Configuration initiale | `QUICK_START_DOCKERHUB.md` |
| Erreurs Docker Hub | `DOCKER_HUB_SETUP.md` section D√©pannage |
| Erreurs GitLab CI | `GITLAB_CI_SETUP.md` section D√©pannage |
| V√©rifier progression | `CHECKLIST.md` |
| Comprendre structure | `PROJECT_STRUCTURE.md` |

### Support

- üìß **Issues GitLab** : Ouvrez une issue sur votre projet
- üìö **Documentation** : Tous les guides sont dans le repo
- üîç **Logs** : Consultez CI/CD ‚Üí Pipelines ‚Üí Job logs

## üìà Prochaines √©tapes sugg√©r√©es

### Imm√©diat (apr√®s configuration)

1. ‚òê V√©rifier que le premier build est r√©ussi
2. ‚òê Tester le pull d'une image depuis Docker Hub
3. ‚òê Mettre √† jour le README avec vos URLs r√©elles

### Court terme (cette semaine)

4. ‚òê Configurer un pipeline programm√© (schedule)
5. ‚òê Cr√©er les descriptions des repos sur Docker Hub
6. ‚òê Configurer Cosign pour signer les images

### Moyen terme (ce mois)

7. ‚òê Activer Renovate pour mises √† jour auto
8. ‚òê Documenter votre processus sp√©cifique
9. ‚òê Mettre en place des tests d'int√©gration

### Long terme (optionnel)

10. ‚òê √âvaluer d'autres registries (Quay.io, etc.)
11. ‚òê Impl√©menter scan de s√©curit√© des images
12. ‚òê Cr√©er des variantes suppl√©mentaires

## üìö Index rapide des commandes

### Docker Hub
```bash
# Cr√©er token
https://hub.docker.com/settings/security

# Tester pull
docker pull VOTRE_USERNAME/tuxedo-aurora-dx:latest
```

### GitLab
```bash
# Variables
https://gitlab.com/NAMESPACE/PROJECT/-/settings/ci_cd

# Pipelines
https://gitlab.com/NAMESPACE/PROJECT/-/pipelines

# Schedules
https://gitlab.com/NAMESPACE/PROJECT/-/pipeline_schedules
```

### Local
```bash
# Script auto
./setup-dockerhub.sh

# Build local
buildah bud --file=Containerfiles/aurora/dx/Containerfile --tag=test .

# Cosign
cosign generate-key-pair
```

## üéì Conclusion

Vous avez maintenant :

‚úÖ Un pipeline GitLab CI/CD fonctionnel
‚úÖ 6 images construites automatiquement
‚úÖ Push vers Docker Hub configur√©
‚úÖ Documentation compl√®te
‚úÖ Scripts d'aide automatis√©s
‚úÖ Support Cosign optionnel
‚úÖ Guides pour chaque niveau d'expertise

**F√©licitations ! üéâ**

Votre projet est maintenant pr√™t √† √™tre d√©ploy√© sur GitLab avec push automatique vers Docker Hub.

---

**Questions ? Consultez les guides d√©taill√©s !**

- üöÄ D√©marrage rapide ‚Üí `QUICK_START_DOCKERHUB.md`
- üê≥ Docker Hub ‚Üí `DOCKER_HUB_SETUP.md`
- ‚öôÔ∏è GitLab CI ‚Üí `GITLAB_CI_SETUP.md`
- ‚úÖ Checklist ‚Üí `CHECKLIST.md`
